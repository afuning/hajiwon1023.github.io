---
title: 浅谈HTTP原理
date: 2018-12-07 16:40:21
tags: HTTP
---
<!--toc-->
## HTTP到底是什么

缩&#160;&#160;写：**HTTP**  
英文名：**HyperText Transfer Protocol** *（称[haɪpə(r)][prəʊtəkɒl]）*   
中文名：**超文本传输协议**  
角&#160;&#160;色：**万维网的数据通信基础**  
位&#160;&#160;置：**7层OSI模型的应用层[^1]**

### 又称：因特网的多媒体信使

提问：*众所周知信使是用来送信的，那么，HTTP送的是什么*

> 客户端发送**HTTP请求**给服务器，服务器发送**HTTP响应**给客户端。一个请求和一个响应称为一个**HTTP事务**，其中带有的资源[^2]、URI[^3]相当于快递员送的包裹以及包裹地址  

提问：*HTTP所送的包裹是怎么样的呢？*

> **HTTP事务**是通过名为HTTP报文的格式化数据块进行的。既然HTTP是英特网的信使，那么**报文**就是他用来搬东西的包裹。

提问：*既然报文是包裹，那么其组成部分怎么样的？*
> 首先**HTTP报文**是简单的格式化数据块。每条报文由三部分组成：对报文进行描述的**起始行**、包含属性的**部首块**、可选的、包含数据的**主体**部分。

如图所示为两类HTTP报文：
![两类HTTP报文](http://www.nomiwan.com/HTTP%E6%8A%A5%E6%96%87.jpg)

1. 请求行包含一个方法，一个请求URL以及版本（1.0前不需要版本
2. 响应行包含版本、数字状态码、以及原因短语，如表格所示数字状态码的大致含义：

|整体范围|    已定义范围    |       分类       |
|:--:|:-------:|:------------- |
|100～199|100～101|信息提示|
|200～299|200～206|成功|
|300～399|300～305|重定向|
|400～499|400～415|客户端错误|
|500～599|500～505|服务器错误|

3. 可选的实体主体是报文的负荷，要传输的内容。
4. 首部从本质来说只是一些名/值对的列表。其中可分为以下几类：

* 通用首部：存在两类报文中
* 请求首部：提供更多有关请求的信息
* 响应首部：提供更多有关响应的信息
* 实体首部：描述主体的长度和内容，或者资源自身
* 拓展首部：规范中未定义的新首部

每个HTTP首部都有一种简单的语法：名字后面跟着冒号（：），然后跟上可选的空格，再跟上字段值，最后是一个CRLF。

### 方法

**GET:** 最常用的方法，通常用于请求服务器发送某个资源。（HTTP/1.0），一般是幂等（一项操作被称为幂等的表示这项操作执行任意多次和执行一次的结果是完全一样的）
**HEAD：**于GET方法类似，但服务器在响应中只返回首部，不会返回实体的主体部分。通常用于：（HTTP/1.0）
* 在不获取资源的情况下了解资源的情况
* 通过查看响应中的状态码，看某个对象是否存在。
* 通过查看首部，测试资源是否被修改了

**PUT：** 向服务器写入文档，用于向服务器上的资源（例如文件）中存储数据

**POST：** 向服务器发送数据，广泛运用于表单提交（HTTP/1.0）

**TRACE：** 用于诊断，验证请求是否如愿穿过了请求/响应链。（缺陷：他假定中间应用程序对不同类型请求的处理是相同的，然而很多HTTP应用会根据不同方法作出不同的事情，那么有可能代理会将POST直接发送给服务器，而将GET请求发送给另一个HTTP应用程序），ps：该请求中不允许带有实体部分，响应的实体主体部分包含了响应服务器收到的请求的精确副本。

**OPTIONS：** 可以不用实际访问资源就能获取Web服务器支持的各种功能。比如通常支持哪种方法，或者对某些特殊资源支持哪些方法，从而判定访问各处资源的最优方式。

**DELETE：** 顾名思义删除请求URL所指定的资源，但无法保证删除操作一定被执行。因为HTTP规范允许服务器在不通知客户端的情况下撤销请求。

**拓展方法：** 顾名思义就是没有在HTTP/1.1规范中定义的方法。比如LOCK，COPY，MOVE。

### 常见首部实例

如图所示为维客一个POST请求：

<General：>  
**Request URL：** 最终请求资源地址  
**Request Method：** 请求的方法  
**Status Code：** 请求状态码  
**Remote Address：** 远程服务器地址  
**Referrer Policy：** request headers（请求头部）中的referer。（该请求使用的是在同等安全等级下（例如https页面请求https地址），发送referer，但当请求方低于发送方（例如https页面请求http地址），不发送referer）

<Response Headers：>  
**Connection：** 告诉服务器本次连接是长连接。不会永久保持连接，它有一个保持时间，可以在不同的服务器软件（如Apache)中设定这个时间。close为关闭长连接。    
**Content-Type：** 返回内容的MIME类型  
**Date：** 原始服务器消息发出的时间  
**Server：** web服务器软件名称（维客这个是由淘宝网发起的Web服务器项目）  
**Set-Cookie：** 用来在浏览器种cookie，一旦被种下，当浏览器访问符合条件的url地址时，会自动带上这个cookie  
**Transfer-Encoding：** 文件传输编码（分块编码(chunked))。一种数据传输机制，允许HTTP由应用服务器发送给客户端应用（ 通常是网页浏览器）的数据可以分成多个部分。分块传输编码只在HTTP协议1.1版本（HTTP/1.1）中提供

<Request Headers：>  
**Accept：** 代表浏览器可以接收的数据类型  
**Accept-Encoding：** 代表浏览器可以接收压缩的数据
**Accept-Language：** 代表客户端浏览器的语言  
**Cache-Control：** 告诉所有的缓存机制是否可以缓存及哪种类型（所有内容都不会被缓存）  
**Content-Length：** 报文中实体主体的大小  
**Content-Type：** 实体主体MIME类型（当action为get时候，客户端把form数据转换成一个字串append到url后面，用?分割。当action为post时候，浏览器把form数据封装到http body中，然后发送到server。并指定文本编码格式）  
**Cookie：** 用于维持服务端会话状态的，通常由服务端写入，在后续请求中，供服务端读取。Cookie的使用过程：  
1. server通过HTTP Response中的"Set-Cookie: header"把cookie发送给client  
2. client把cookie通过HTTP Request 中的“Cookie: header”发送给server  
3. 每次HTTP请求，Cookie都会被发送。  

**Pragma：** 优先级是高于Cache-Control，html里面的mate标签中指定no-catch，不过仅在IE中有效  
**Referer：** 访问的域名地址，由浏览器生成，并不是所有浏览器都会设置该值。可以伪造，并不可信  
**User-Agent：** 代表的是客户端浏览器
## HTTP演变过程

### 起源

是由蒂姆·伯纳斯-李于1989年在欧洲核子研究组织（CERN）所发起，标准制定由万维网协会（World Wide Web Consortium，W3C）和互联网工程任务组（Internet Engineering Task Force，IETF）进行协调，最终发布了一系列的RFC。

### 版本演化

|时间|    版本    |       特性       |      改进     |     缺陷     |
|:--:|:-------:|:------------- |:---------- |:---------- |
|1990|   HTTP/0.9  |只接受GET一种请求方法，没有在通讯中指定版本号，且不支持请求头。|     |  功能单一，由于不支持POST客户端无法向服务器传递太多信息  |
|1996|   HTTP/1.0  |第一个在通讯中指定版本号的HTTP协议版本，至今仍被广泛采用，特别是在代理服务器中。|任何格式的内容都可以发送。可以**传输文字，图像、视频、二进制文件**。还引入了**POST和HEAD**。HTTP请求和回应的格式必须包括**头信息（HTTP header）**新增还包括**状态码（status code）、多字符集支持、多部分发送（multi-part type）、权限（authorization）、缓存（cache）、内容编码（content encoding）等**|规定浏览器与服务器**只保持短暂的连接**，浏览器的每次请求都需要与服务器建立一个TCP连接。为此引入**keep-alive**连接，默认关闭，需主动打开。|
|1997|HTTP/1.1|当前广泛使用版本|引入**持久连接**，默认情况激活。**管道化连接**，将多条请求放入队列。新增动词：**PUT、PATCH、HEAD、 OPTIONS、DELETE**|同一个TCP连接里面，所有的数据通信是按次序进行的。服务器只有处理完一个回应，才会进行下一个回应。要是前面的回应特别慢，后面就会有许多请求排队等着。这称为**队头堵塞**|
|2015|HTTP/2.0|关注性能大幅提升|对HTTP头字段进行**数据压缩(即HPACK算法)**。新增**服务端推送(Server Push)**，即接收到客户端主请求，能够“预测”主请求的依赖资源，在响应主请求的同时，主动并发推送依赖资源至客户端。请求**管线化**|从 HTTP/1.1 转向 HTTP/2 势必是漫长的，升级容易，但只要绝大多数人使用老旧浏览器，则会很麻烦|

## HTTP是如何工作的

### HTTP连接

HTTP连接是HTTP报文传输的关键通道，世界上几乎所有的HTTP通信都是由TCP/IP承载的。HTTP连接实际上就是TCP连接及其使用规则。

#### TCP/IP

1、具体含义：TCP/IP是全球计算机及网络设备都在使用的一种常用的分组交换网络分层协议集。一般来说，TCP/IP是利用IP进行通信时所必须用到的协议群的统称。具体来说IP或ICMP、TCP或UDP、TELENT或FTP、以及HTTP等都属于TCP/IP协议。

如图所示：HTTP即位于Application层（HTTPS则是在Application层和Transport层增加安全层），TCP则位于Transport层，IP位于Internet层：TCP/IP四层模型分为应用层、运输层、网络层、数据链路层
![TCP/IP](http://www.nomiwan.com/TCP:IP%E5%8D%8F%E8%AE%AE%E7%BE%A4.png)

3、传输形式：HTTP以流的形式将报文数据的内容通过一条打开的TCP连接按序传输，TCP将数据流砍成段，封装在IP分组中。通过英特网进行传输。如图所示：
![TCP数据流](http://www.nomiwan.com/TCP%E6%95%B0%E6%8D%AE%E6%B5%81.png)

#### TCP连接

如图所示是一次web浏览器与web服务器之间连接的步骤：
![TCP/IP连接](http://www.nomiwan.com/TCP:IP%E8%BF%9E%E6%8E%A5.png)

三次握手以及四次挥手均为实现数据的可靠传输，TCP要在应用进程间建立传输连接。它是在两个传输用户之间建立一种逻辑联系，使得通信双方都确认对方为自己的传输连接端点。
![四次挥手](http://www.nomiwan.com/%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B%E5%8A%A8%E5%9B%BE.gif)
### HTTP架构

这里有几个概念：  
**WEB服务器：** 可以用来表示Web服务器的软件，也可以用来表示提供Web页面的特定设备或计算机。会对HTTP请求进行处理并提供响应  
**WEB代理服务器：** 位于客户端和服务器之间，扮演“中间人”的角色。即是客户端又是Web服务器  
**WEB缓存：** 是可以自动保存常见文档副本的HTTP设备。  
**网关：** 在HTTP和其他协议及应用程序之间起到接口作用，是资源和应用程序之间的粘合剂。如：服务器协议转换器、服务端安全网关、客户端安全网关、应用程序服务器。  
**隧道：** 允许用户通过HTTP连接发送非HTTP流量  
**中继：** 负责处理HTTP中建立连接的部分，然后对字节进行盲转发（有一个哑代理的问题）  

### HTTP优化和加速

#### 延时原因

HTTP紧挨着TCP，位于其上层，因此HTTP事务的性能很大程度上取决于底层TCP通道的性能。与建立TCP连接以及传输请求和响应报文的时间相比，事务处理时间可能很短，除非特殊情况。大多数情况下HTTP延时是由TCP网络时延构成的。以下列举影响速度的原因

1. 若最近没有对URI中的主机名进行访问，通过DNS解析主机名为IP地址需要花费数十秒时间（DNS缓存）
2. 客户端发送一条TCP连接请求，并等待请求接受应答，每条TCP连接都有连接建立时延，通常最多只有一两秒，但叠加起来
3. 传输请求报文以及服务器处理请求报文时间
4. 回传响应报文

> TCP网络延迟时间大小取决于硬件的速度、网络和服务器的负载、请求和响应报文的尺寸、客户端与服务器之间的距离等。

#### HTTP连接优化
**串行连接：** 每个事务都需要建立一条新的TCP连接

如图所示原始的串行事务处理：  
![串行连接](http://www.nomiwan.com/%E4%B8%B2%E8%A1%8C%E8%BF%9E%E6%8E%A5.png)
缺陷：TCP的性能延时可能叠加起来，视觉上会让人觉得很慢，比如加载图片。

**并行连接：** 通过多条TCP连接发起并发的HTTP请求。

目前浏览器使用了并行连接，如图所示：
![浏览器并行连接](http://www.nomiwan.com/%E5%B9%B6%E8%A1%8C%E8%BF%9E%E6%8E%A5.png)

如图为并行连接时间线：
![并行连接](http://www.nomiwan.com/%E5%B9%B6%E8%A1%8C%E8%BF%9E%E6%8E%A5%E5%9B%BE%E7%A4%BA.png)
缺陷：有可能受带宽的限制，每个对象都按照较慢的速度加载，打开大量连接会消耗很多内存资源，从而引发自身的性能问题。因此浏览器会将并行连接数限制一个较小的数。

**持久连接：** 在事务处理结束之后仍然保持在打开状态的TCP连接。

如图为持久连接时间线：
![持久连接](http://www.nomiwan.com/%E6%8C%81%E4%B9%85%E8%BF%9E%E6%8E%A5.png)
缺陷：有可能累积大量的空闲连接。有可能因为盲中继使浏览器一直处于挂起的状态  
现代浏览器通常是使用并行连接+持久连接  

**管道化连接：** 在响应到达之前，可以讲多条请求放入队列。

如图为管道化连接时间线：
![管道化连接](http://www.nomiwan.com/%E7%AE%A1%E9%81%93%E5%8C%96%E8%BF%9E%E6%8E%A5.png)

管道化连接的限制，由于实现复杂，不易调试，不标准的代理导致管道化会出现很多问题，因此浏览器默认状态下并不激活：
  
    1. 连接必须是持久的  
    2. 响应的顺序与请求的顺序应相同  
    3. 客户端需有应对过早关闭连接的情况  
    4. 不要通过管道化连接使用产生副作用的请求（例如POST），因为存在不会执行的风险  

**其他优化**

TCP连接复用：将前端多个客户的HTTP请求复用到后端与服务器建立的一个TCP连接上如图：
![TCP复用](http://www.nomiwan.com/TCP%E5%A4%8D%E7%94%A8%E6%8A%80%E6%9C%AF.png)
优点：减小服务器的性能负载，减少与服务器之间新建TCP连接所带来的延时，并最大限度的降低客户端对后端服务器的并发连接数请求，减少服务器的资源占用。

HTTP压缩：对内容进行编码，比如gzip来压缩html,javascript, CSS文件，减少网络传输的数据量，提高了速度。
![HTTP压缩](http://www.nomiwan.com/HTTP%E5%8E%8B%E7%BC%A9.png)

负载均衡技术：TCP连接复用、内容缓存、TCP缓冲、HTTP压缩、SSL加速  
阿里云塔内负载均衡价格：据说一年1万元

## HTTP应用

### 手写http连接

### 文件传输
![图片上传](http://www.nomiwan.com/%E5%9B%BE%E7%89%87%E4%B8%8A%E4%BC%A0.png)
https://www.jianshu.com/p/959b7ad06467

## HTTP/2

2015年5月, HTTP/2.0 正式发表

### 如何使用上 HTTP/2

1. 客户端支持，目前最新版各大浏览器都已支持
2. WEB服务器支持

### 新增特性

**二进制分帧** 在应用层与传输层之间增加一个二进制分帧层。HTTP2.0会将所有传输的信息分割为更小的消息和帧,并对它们采用二进制格式的编码，其中HTTP1.x的首部信息会被封装到Headers帧，而我们的request body则封装到Data帧里面。

**压缩头部** 客户端和服务器端会使用并且维护「首部表」来跟踪和存储之前发送的键值对，因此重复的头部不必再请求发送。新增或修改的首部帧会被追加到“首部表”

**多路复用** 在一条连接上发送无数个请求，并且响应可以同时返回。也就是说在一个连接上可以承载任意数量的双向数据流。因此之前所做的合并 JS、CSS 文件技巧，反而不适用了

**请求优先级** 即所有资源都是并行发送，那么就需要「优先级」的概念了，这样就可以对重要的文件进行先传输，加速页面的渲染

**服务器推送** 还没有收到浏览器的请求，服务器就把各种资源推送给浏览器。比如请求了一个index.html，服务器就主动把里面的css、js全部发送给浏览器

**强制 SSL** 浏览器强制要求使用 HTTP/2.0 必须要用上 SSL

### 对优化的影响

1. 没有必要合并文件，制作雪碧图来减少连接数，因为只有一个连接。  
2. 因为资源都是并行交错发送，且没有限制，不需要浏览器对同一域名的链接数的限制  
3. 内嵌资源的优化手段也变得没有意义了  
其实1、3优化都是为了减少连接数，而HTTP/2的多路复用的特点就是一条连接并行交错发送资源、且没有限制


1、HTTP/2与HTTP/1.1的比较

[^1]: 如图：![7层OSI模型的应用层](http://www.nomiwan.com/7%E5%B1%82OSI%E6%A8%A1%E5%9E%8B.jpg) 

[^2]: 有静态文件，也有**动态内容。静态资源**包括*文本文件、HTML文件、Word文件、图片文件、视频文件*等。动态内容即是根据身份、所求信息、不同时段产生不同内容。并通过**MIME**来描述并标记媒体内容例如：```Content-type: image/jpeg```

[^3]: 称为统一资源标识符（Uniform Resource Identifier），有两种形式分别称为**URL（统一资源定位符）**和**URN（统一资源名）**。URL由三部分组成*协议类型*（`http://`）、*服务器的英特网地址*（www.google.com）、*服务器上的某个资源*（/images/example.jpg）例如：<http://www.google.com/images/example.jpg>
